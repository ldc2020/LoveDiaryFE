<!--æƒ…ä¾£è®¡åˆ’é¡µé¢æ¨¡æ¿-->
<view class="plan-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">æƒ…ä¾£è®¡åˆ’</text>
    <view class="smart-input-btn" bindtap="showSmartInput">
      <text class="iconfont icon-add"></text>
      <text>æ™ºèƒ½æ·»åŠ </text>
    </view>
  </view>

  <!-- ç§»é™¤æ ‡ç­¾é¡µå¯¼èˆªï¼Œæ”¹ä¸ºå¡ç‰‡å¼å¸ƒå±€ -->

  <!-- è®¡åˆ’å¡ç‰‡ç½‘æ ¼å¸ƒå±€ -->
  <scroll-view class="plan-content" scroll-y="true" enhanced="true">
    <view class="plan-cards-grid">
      
      <!-- å½±è§†è®¡åˆ’å¡ç‰‡ -->
      <view class="plan-card" bindtap="navigateToPlanDetail" data-type="movie">
        <view class="card-icon">ğŸ¬</view>
        <view class="card-content">
          <text class="card-title">å½±è§†è®¡åˆ’</text>
          <text class="card-count">{{planCounts.movie}}</text>
        </view>
      </view>

      <!-- çƒ¹é¥ªè®¡åˆ’å¡ç‰‡ -->
      <view class="plan-card" bindtap="navigateToPlanDetail" data-type="cooking">
        <view class="card-icon">ğŸ³</view>
        <view class="card-content">
          <text class="card-title">çƒ¹é¥ªè®¡åˆ’</text>
          <text class="card-count">{{planCounts.cooking}}</text>
        </view>
      </view>

      <!-- è¿åŠ¨æ‰“å¡å¡ç‰‡ -->
      <view class="plan-card" bindtap="navigateToPlanDetail" data-type="exercise">
        <view class="card-icon">ğŸ’ª</view>
        <view class="card-content">
          <text class="card-title">è¿åŠ¨æ‰“å¡</text>
          <text class="card-count">{{planCounts.exercise}}</text>
        </view>
      </view>

      <!-- æ—…æ¸¸è®¡åˆ’å¡ç‰‡ -->
      <view class="plan-card" bindtap="navigateToPlanDetail" data-type="travel">
        <view class="card-icon">âœˆï¸</view>
        <view class="card-content">
          <text class="card-title">æ—…æ¸¸è®¡åˆ’</text>
          <text class="card-count">{{planCounts.travel}}</text>
        </view>
      </view>

      <!-- æ¢åº—è®¡åˆ’å¡ç‰‡ -->
      <view class="plan-card" bindtap="navigateToPlanDetail" data-type="shop">
        <view class="card-icon">ğŸª</view>
        <view class="card-content">
          <text class="card-title">æ¢åº—è®¡åˆ’</text>
          <text class="card-count">{{planCounts.shop}}</text>
        </view>
      </view>
      
      <!-- ä¸´æ—¶å¤‡å¿˜å¡ç‰‡ -->
      <view class="plan-card" bindtap="navigateToPlanDetail" data-type="memo">
        <view class="card-icon">ğŸ“</view>
        <view class="card-content">
          <text class="card-title">ä¸´æ—¶å¤‡å¿˜</text>
          <text class="card-count">{{planCounts.memo}}</text>
        </view>
      </view>
      
    </view>

  </scroll-view>

  <!-- æ™ºèƒ½è¾“å…¥å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showInputModal}}" bindtap="hideInputModal">
    <view class="input-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ™ºèƒ½æ·»åŠ è®¡åˆ’</text>
        <view class="modal-close" bindtap="hideInputModal">
          <text class="iconfont icon-close"></text>
        </view>
      </view>
      
      <view class="modal-content" catchtap="stopPropagation">
        <view class="input-tip">
          <text>è¯·è¾“å…¥æˆ–ç²˜è´´è®¡åˆ’å†…å®¹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹¶å½’ç±»ï¼š</text>
        </view>
        
        <textarea 
          class="smart-input" 
          placeholder="ä¾‹å¦‚ï¼š\nâ€¢ çœ‹ç”µå½±ã€Šé˜¿å‡¡è¾¾ã€‹ï¼Œå¯¼æ¼”è©¹å§†æ–¯Â·å¡æ¢…éš†\nâ€¢ åšçº¢çƒ§è‚‰ï¼Œéœ€è¦äº”èŠ±è‚‰500gï¼Œç”ŸæŠ½2å‹º\nâ€¢ å‡è‚¥åˆ°55kg\nâ€¢ å»åŒ—äº¬æ—…æ¸¸ï¼Œå‚è§‚æ•…å®«å’Œé•¿åŸ\nâ€¢ æ¢åº—ï¼šä¸‰é‡Œå±¯çš„ç½‘çº¢å’–å•¡å…"
          value="{{inputText}}"
          bindinput="onInputChange"
          catchtap="stopPropagation"
          maxlength="1000"
          auto-height
        ></textarea>
        
        <view class="input-actions">
          <button class="cancel-btn" bindtap="hideInputModal">å–æ¶ˆ</button>
          <button class="confirm-btn" bindtap="analyzeInputText" loading="{{isAnalyzing}}">
            {{isAnalyzing ? 'åˆ†æä¸­...' : 'æ™ºèƒ½è¯†åˆ«'}}
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- è®¡åˆ’è¯¦æƒ…å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showDetailModal}}" bindtap="hidePlanDetail">
    <view class="detail-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">è®¡åˆ’è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hidePlanDetail">
          <text class="iconfont icon-close"></text>
        </view>
      </view>
      
      <view class="modal-content" wx:if="{{currentPlanDetail}}" catchtap="stopPropagation">
        
        <!-- å½±è§†è®¡åˆ’è¯¦æƒ… -->
        <view wx:if="{{currentPlanDetail.type === 'movie'}}">
          <view class="detail-item">
            <text class="detail-label">ç”µå½±åç§°ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.movieName}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ç”µå½±ä¿¡æ¯ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.movieInfo}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">è§‚çœ‹çŠ¶æ€ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.watched ? 'å·²è§‚çœ‹' : 'æœªè§‚çœ‹'}}</text>
          </view>
        </view>
        
        <!-- çƒ¹é¥ªè®¡åˆ’è¯¦æƒ… -->
        <view wx:if="{{currentPlanDetail.type === 'cooking'}}">
          <view class="detail-item">
            <text class="detail-label">é£Ÿæï¼š</text>
            <text class="detail-value">{{currentPlanDetail.ingredients.join(', ')}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">ç”¨é‡ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.portions.join(', ')}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å°è¯•çŠ¶æ€ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.tried ? 'å·²å°è¯•' : 'æœªå°è¯•'}}</text>
          </view>
          <view class="detail-item" wx:if="{{currentPlanDetail.rating > 0}}">
            <text class="detail-label">è¯„åˆ†ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.rating}}/5</text>
          </view>
        </view>
        
        <!-- è¿åŠ¨è®¡åˆ’è¯¦æƒ… -->
        <view wx:if="{{currentPlanDetail.type === 'exercise'}}">
          <view class="detail-item">
            <text class="detail-label">ç›®æ ‡ä½“é‡ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.targetWeight}}kg</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">å½“å‰ä½“é‡ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.currentWeight || 'æœªè®°å½•'}}kg</text>
          </view>
        </view>
        
        <!-- æ—…æ¸¸è®¡åˆ’è¯¦æƒ… -->
        <view wx:if="{{currentPlanDetail.type === 'travel'}}">
          <view class="detail-item">
            <text class="detail-label">è¡Œç¨‹ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.itinerary}}</text>
          </view>
          <view class="detail-item" wx:if="{{currentPlanDetail.travelDate}}">
            <text class="detail-label">è®¡åˆ’æ—¥æœŸï¼š</text>
            <text class="detail-value">{{currentPlanDetail.travelDate}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ¸¸ç©çŠ¶æ€ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.visited ? 'å·²å»è¿‡' : 'æœªå»è¿‡'}}</text>
          </view>
        </view>
        
        <!-- æ¢åº—è®¡åˆ’è¯¦æƒ… -->
        <view wx:if="{{currentPlanDetail.type === 'shop'}}">
          <view class="detail-item">
            <text class="detail-label">åº—é“ºåç§°ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.shopName}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">åœ°åŒºï¼š</text>
            <text class="detail-value">{{currentPlanDetail.region}}</text>
          </view>
          <view class="detail-item">
            <text class="detail-label">æ¢åº—çŠ¶æ€ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.visited ? 'å·²æ¢åº—' : 'æœªæ¢åº—'}}</text>
          </view>
        </view>
        
        <!-- å¤‡å¿˜å½•è¯¦æƒ… -->
        <view wx:if="{{currentPlanDetail.type === 'memo'}}">
          <view class="detail-item">
            <text class="detail-label">å¤‡å¿˜å†…å®¹ï¼š</text>
            <text class="detail-value">{{currentPlanDetail.memo}}</text>
          </view>
        </view>
        
        <!-- é€šç”¨ä¿¡æ¯ -->
        <view class="detail-item">
          <text class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</text>
          <text class="detail-value">{{currentPlanDetail.createTime}}</text>
        </view>
        
        <view class="detail-item">
          <text class="detail-label">åŸå§‹æ–‡æœ¬ï¼š</text>
          <text class="detail-value original-text">{{currentPlanDetail.originalText}}</text>
        </view>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <view class="detail-actions">
          <button class="action-btn status-btn" 
                  bindtap="togglePlanStatus"
                  data-plan="{{currentPlanDetail}}" 
                  data-type="{{currentPlanDetail.type}}">
            {{currentPlanDetail.status === 'completed' ? 'æ ‡è®°æœªå®Œæˆ' : 'æ ‡è®°å®Œæˆ'}}
          </button>
          <button class="action-btn delete-btn" 
                  bindtap="deletePlan"
                  data-planid="{{currentPlanDetail._id}}" 
                  data-type="{{currentPlanDetail.type}}">
            åˆ é™¤è®¡åˆ’
          </button>
          <button class="action-btn edit-btn"
                  bindtap="showEditDetailModal">
            ä¿®æ”¹è¯¦æƒ…
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘è¯¦æƒ…å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showEditDetailModal}}" bindtap="hideEditDetailModal">
    <view class="input-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ç¼–è¾‘è®¡åˆ’è¯¦æƒ…</text>
        <view class="modal-close" bindtap="hideEditDetailModal">
          <text class="iconfont icon-close"></text>
        </view>
      </view>
      <view class="modal-content">
        <!-- åªå±•ç¤ºå¯ç¼–è¾‘å­—æ®µï¼Œä¸¾ä¾‹ï¼šmemoã€movieNameã€itineraryç­‰ -->
        <view wx:if="{{editDetail.type === 'memo'}}">
          <textarea class="smart-input" value="{{editDetail.memo}}" data-field="memo" bindinput="onEditDetailInput"></textarea>
        </view>
        <view wx:if="{{editDetail.type === 'movie'}}">
          <input class="smart-input" value="{{editDetail.movieName}}" data-field="movieName" bindinput="onEditDetailInput" />
          <textarea class="smart-input" value="{{editDetail.movieInfo}}" data-field="movieInfo" bindinput="onEditDetailInput"></textarea>
        </view>
        <view wx:if="{{editDetail.type === 'travel'}}">
          <textarea class="smart-input" value="{{editDetail.itinerary}}" data-field="itinerary" bindinput="onEditDetailInput"></textarea>
          <input class="smart-input" value="{{editDetail.travelDate}}" data-field="travelDate" bindinput="onEditDetailInput" />
        </view>
        <!-- å…¶ä»–ç±»å‹å¯æŒ‰éœ€è¡¥å…… -->
        <view class="input-actions">
          <button class="cancel-btn" bindtap="hideEditDetailModal">å–æ¶ˆ</button>
          <button class="confirm-btn" bindtap="saveEditDetail">ä¿å­˜</button>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰‹åŠ¨æ·»åŠ ç”µå½±å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showManualAddModal}}" bindtap="hideManualAdd">
    <view class="input-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ å½±è§†è®¡åˆ’</text>
        <view class="modal-close" bindtap="hideManualAdd">
          <text class="iconfont icon-close"></text>
        </view>
      </view>
      
      <view class="modal-content" catchtap="stopPropagation">
        <view class="input-tip">
          <text>è¯·è¾“å…¥ç”µå½±åç§°ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨æœç´¢ç”µå½±ä¿¡æ¯ï¼š</text>
        </view>
        
        <input 
          class="movie-input" 
          placeholder="è¯·è¾“å…¥ç”µå½±åç§°"
          value="{{movieName}}"
          bindinput="onMovieNameInput"
          catchtap="stopPropagation"
        ></input>

        <view class="movie-info" wx:if="{{movieInfo}}">
          <view class="info-item">
            <text class="info-label">ç”µå½±åç§°ï¼š</text>
            <text class="info-value">{{movieInfo.title}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">å¯¼æ¼”ï¼š</text>
            <text class="info-value">{{movieInfo.director}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">ä¸»æ¼”ï¼š</text>
            <text class="info-value">{{movieInfo.actors}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">ç®€ä»‹ï¼š</text>
            <text class="info-value">{{movieInfo.summary}}</text>
          </view>
        </view>
        
        <view class="input-actions">
          <button class="cancel-btn" bindtap="hideManualAdd">å–æ¶ˆ</button>
          <button class="search-btn" bindtap="searchMovie" loading="{{isSearching}}" wx:if="{{!movieInfo}}">
            æœç´¢ç”µå½±
          </button>
          <button class="confirm-btn" bindtap="addMoviePlan" loading="{{isAdding}}" wx:if="{{movieInfo}}">
            æ·»åŠ è®¡åˆ’
          </button>
        </view>
      </view>
    </view>
  </view>

  <!-- è°ƒè¯•é¢æ¿ -->
  <debug-panel></debug-panel>

</view>
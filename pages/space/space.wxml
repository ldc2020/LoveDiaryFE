<view class="container">
  <!-- å…¨å±€èƒŒæ™¯ -->
  <image class="global-bg-image" src="{{backgroundImage}}" mode="aspectFill"/>
  <!-- å†…å®¹åŒºåŸŸ -->
  <view class="content-area">
    <!-- æƒ…ä¾£åœˆå†…å®¹åˆ—è¡¨ -->
    <view class="moments-list">
      <view class="moment-item" wx:for="{{moments}}" wx:key="_id">
        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <view class="user-info">
          <image class="avatar" src="{{item._openid === currentUserOpenid ? (userInfo.localAvatarPath || userInfo.avatarUrl || './images/default-avatar.png') : (item._openid === partnerId ? (partnerInfo.avatarUrl || './images/default-avatar.png') : './images/default-avatar.png')}}" mode="aspectFill"></image>
          <view class="user-details">
            <text class="username">{{item._openid === currentUserOpenid ? (userInfo.nickName || 'æˆ‘') : (item._openid === partnerId ? (partnerInfo.nickName || 'TA') : 'æœªçŸ¥ç”¨æˆ·')}}</text>
            <text class="time">{{item.formattedTime}}</text>
          </view>
          <!-- åˆ é™¤æŒ‰é’® -->
          <view class="delete-btn" bindtap="deleteMoment" data-id="{{item._id}}" data-index="{{index}}">
            <text class="delete-icon">ğŸ—‘ï¸</text>
          </view>
        </view>
        
        <!-- æ–‡æ¡ˆå†…å®¹ -->
        <view class="content" wx:if="{{item.content}}">
          <text>{{item.content}}</text>
        </view>
        
        <!-- å›¾ç‰‡åŒºåŸŸ -->
        <view class="image-container" wx:if="{{item.images && item.images.length > 0}}">
          <!-- å•å¼ å›¾ç‰‡æ˜¾ç¤º -->
          <view class="single-image-container" wx:if="{{item.images.length === 1}}">
            <image 
              class="single-image" 
              src="{{item.images[0].localPath || item.images[0].url || item.images[0]}}" 
              mode="aspectFill"
              bindtap="previewImage"
              data-urls="{{item.images}}"
              data-current="{{item.images[0].cloudUrl || item.images[0].url || item.images[0]}}"
            ></image>
          </view>
          
          <!-- å¤šå¼ å›¾ç‰‡ä¹å®«æ ¼æ˜¾ç¤º -->
          <view class="grid-container" wx:else>
            <view class="image-grid grid-{{item.images.length > 9 ? 9 : item.images.length}}">
              <image 
                class="grid-image" 
                wx:for="{{item.images}}" 
                wx:for-item="img" 
                wx:for-index="imgIndex"
                wx:key="imgIndex"
                wx:if="{{imgIndex < 9}}"
                src="{{img.localPath || img.url || img}}" 
                mode="aspectFill"
                bindtap="previewImage"
                data-urls="{{item.images}}"
                data-current="{{img.cloudUrl || img.url || img}}"
              ></image>
              <!-- è¶…è¿‡9å¼ å›¾ç‰‡æ—¶æ˜¾ç¤º+å· -->
              <view class="more-images" wx:if="{{item.images.length > 9}}" bindtap="previewImage" data-urls="{{item.images}}" data-current="{{item.images[8].cloudUrl || item.images[8].url || item.images[8]}}">
                <text class="more-count">+{{item.images.length - 8}}</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- äº’åŠ¨åŒºåŸŸ -->
        <view class="interaction-area">
          <view class="like-btn-container">
            <view class="like-btn" bindtap="toggleLike" data-id="{{item._id}}" data-index="{{index}}">
              <text class="icon">â¤ï¸</text>
              <text class="count">{{item.likes || 0}}</text>
            </view>
            <!-- ç‚¹èµé£˜å¿ƒæ•ˆæœ -->
            <view class="floating-hearts" wx:if="{{item.showHearts}}">
              <view class="floating-heart heart-1">ğŸ’•</view>
              <view class="floating-heart heart-2">ğŸ’–</view>
              <view class="floating-heart heart-3">ğŸ’</view>
            </view>
          </view>
          <view class="comment-btn" bindtap="showCommentInput" data-id="{{item._id}}">
            <text class="icon">ğŸ’¬</text>
            <text class="count">{{item.comments ? item.comments.length : 0}}</text>
          </view>
        </view>
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        <view class="comments-section" wx:if="{{item.comments && item.comments.length > 0}}">
          <view class="comment-item" wx:for="{{item.comments}}" wx:for-item="comment" wx:key="id">
            <view class="comment-content">
              <text class="comment-user">{{comment._openid === currentUserOpenid ? (userInfo.nickName || 'æˆ‘') : (comment._openid === partnerId ? (partnerInfo.nickName || 'TA') : 'æœªçŸ¥ç”¨æˆ·')}}</text>
              <text class="comment-text">{{comment.content}}</text>
            </view>
          </view>
    </view>
  </view>
  
  <!-- è°ƒè¯•é¢æ¿ -->
  <debug-panel></debug-panel>
</view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{moments.length === 0 && !loading}}">
      <text class="empty-text">è¿˜æ²¡æœ‰åŠ¨æ€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§~</text>
    </view>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-state" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
    
    <!-- åŠ è½½æ›´å¤šçŠ¶æ€ -->
    <view class="load-more-state" wx:if="{{moments.length > 0}}">
      <view class="loading-more" wx:if="{{loadingMore}}">
        <text>åŠ è½½æ›´å¤šä¸­...</text>
      </view>
      <view class="no-more" wx:elif="{{!hasMore}}">
        <text>æ²¡æœ‰æ›´å¤šäº†</text>
      </view>
    </view>
  </view>
  
  <!-- å‘å¸ƒæŒ‰é’® -->
  <view class="fab-btn" bindtap="showPublishModal">
    <text class="fab-icon">+</text>
  </view>
  
  <!-- å‘å¸ƒå¼¹çª— -->
  <view class="publish-modal {{showPublishModal ? 'show' : ''}}" catchtap="hidePublishModal" wx:if="{{moments.length === 0 || showPublishModal}}">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">å‘å¸ƒåŠ¨æ€</text>
        <text class="close-btn" bindtap="hidePublishModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <!-- æ–‡æ¡ˆè¾“å…¥åŒºåŸŸ -->
        <textarea 
          class="content-input" 
          placeholder="{{publishContent ? '' : 'åˆ†äº«ä½ ä»¬çš„ç¾å¥½æ—¶å…‰...ï¼ˆå¯é€‰ï¼‰'}}"
          value="{{publishContent}}"
          bindinput="onContentInput"
          maxlength="500"
        ></textarea>
        
        <!-- å›¾ç‰‡é€‰æ‹©åŒºåŸŸ -->
        <view class="image-selector">
          <view class="selected-images">
            <view class="image-item" wx:for="{{selectedImages}}" wx:key="index">
              <image src="{{item}}" mode="aspectFill"></image>
              <view class="delete-image" bindtap="removeImage" data-index="{{index}}">Ã—</view>
            </view>
            <view class="add-image" wx:if="{{selectedImages.length < 9}}" bindtap="selectImages">
              <text class="add-icon">+</text>
              <text class="add-text">{{selectedImages.length === 0 ? 'æ·»åŠ å›¾ç‰‡\nï¼ˆå¿…éœ€ï¼‰' : 'æ·»åŠ æ›´å¤šå›¾ç‰‡'}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="hidePublishModal">å–æ¶ˆ</button>
        <button class="publish-btn" bindtap="publishMoment" disabled="{{publishing}}">{{publishing ? 'å‘å¸ƒä¸­...' : 'å‘å¸ƒ'}}</button>
      </view>
    </view>
  </view>
  
  <!-- è¯„è®ºè¾“å…¥å¼¹çª— -->
  <view class="comment-modal {{showCommentModal ? 'show' : ''}}" catchtap="hideCommentModal" wx:if="{{moments.length === 0 || showCommentModal}}">
    <view class="comment-input-area" catchtap="stopPropagation">
      <input 
        class="comment-input" 
        placeholder="{{commentText ? '' : 'å†™ä¸‹ä½ çš„è¯„è®º...'}}" 
        value="{{commentText}}"
        bindinput="onCommentInput"
        confirm-type="send"
        bindconfirm="submitComment"
      />
      <button class="send-btn" bindtap="submitComment" disabled="{{!commentText}}">å‘é€</button>
    </view>
  </view>
  
  <!-- è°ƒè¯•é¢æ¿ -->
  <debug-panel></debug-panel>
</view>
# 情侣计划功能开发文档

## 项目概述

基于现有Love Diary微信小程序，扩展情侣计划功能模块，包含电影计划、烹饪计划、运动打卡、旅游计划等多个子模块。

### 技术架构

- **前端框架**: 微信小程序原生开发
- **云服务**: 微信云开发 (env: cloud1-3gxic0n80d5341e3)
- **数据存储**: 云数据库
- **云函数**: Node.js
- **用户绑定**: 基于openId的情侣配对机制

## 一、数据模型设计

### 1.1 基础计划模型 (BasePlan)

```javascript
{
  _id: String,
  _openid: String,        // 创建者openId
  coupleId: String,       // 情侣ID (复用现有绑定机制)
  partnerId: String,      // 伴侣openId
  type: String,           // 计划类型: movie/cooking/sport/travel/memo/shop/task
  title: String,          // 计划标题
  description: String,    // 计划描述
  status: Number,         // 状态: 0-未开始 1-进行中 2-已完成 3-已取消
  priority: Number,       // 优先级: 1-低 2-中 3-高
  createTime: Date,       // 创建时间
  updateTime: Date,       // 更新时间
  startDate: Date,        // 开始日期
  endDate: Date,          // 结束日期
  remindTime: Date,       // 提醒时间
  tags: Array,            // 标签数组
  isPrivate: Boolean,     // 是否私密计划
  completedBy: Array      // 完成者列表 [{openId, time, note}]
}
```

### 1.2 电影计划 (MoviePlan)

```javascript
{
  ...BasePlan,
  movieName: String,      // 电影名称
  director: String,       // 导演
  actors: Array,          // 主演列表
  genre: Array,           // 类型标签
  duration: Number,       // 时长(分钟)
  releaseDate: Date,      // 上映日期
  poster: String,         // 海报图片URL
  rating: Number,         // 评分 (0-10)
  watchDate: Date,        // 观看日期
  cinema: String,         // 影院名称
  seatInfo: String,       // 座位信息
  ticketPrice: Number,    // 票价
  watched: Boolean,       // 是否已观看
  review: String,         // 观后感
  photos: Array           // 观影照片
}
```

### 1.3 烹饪计划 (CookingPlan)

```javascript
{
  ...BasePlan,
  dishName: String,       // 菜品名称
  cuisine: String,        // 菜系
  difficulty: Number,     // 难度等级 1-5
  cookingTime: Number,    // 烹饪时间(分钟)
  servings: Number,       // 份数
  ingredients: Array,     // 食材列表 [{name, amount, unit, bought}]
  steps: Array,           // 制作步骤 [{step, description, image, time}]
  tools: Array,           // 所需工具
  nutrition: Object,      // 营养信息 {calories, protein, fat, carbs}
  cost: Number,           // 成本
  tried: Boolean,         // 是否已尝试
  rating: Number,         // 评分 (0-5)
  notes: String,          // 制作心得
  photos: Array           // 成品照片
}
```

### 1.4 运动打卡 (SportPlan)

```javascript
{
  ...BasePlan,
  sportType: String,      // 运动类型
  targetWeight: Number,   // 目标体重
  currentWeight: Number,  // 当前体重
  weightHistory: Array,   // 体重记录 [{date, weight, note}]
  targetDuration: Number, // 目标时长(分钟)
  actualDuration: Number, // 实际时长
  calories: Number,       // 消耗卡路里
  location: String,       // 运动地点
  equipment: Array,       // 运动器材
  checkInDates: Array,    // 打卡日期
  photos: Array,          // 运动照片
  achievements: Array     // 成就记录
}
```

### 1.5 旅游计划 (TravelPlan)

```javascript
{
  ...BasePlan,
  destination: String,    // 目的地
  country: String,        // 国家
  city: String,           // 城市
  budget: Number,         // 预算
  actualCost: Number,     // 实际花费
  transportation: String, // 交通方式
  accommodation: String,  // 住宿信息
  itinerary: Array,       // 行程安排 [{day, activities, cost}]
  attractions: Array,     // 景点列表 [{name, visited, rating, photos}]
  weather: Object,        // 天气信息
  documents: Array,       // 证件清单 [{type, status}]
  packing: Array,         // 打包清单 [{item, packed}]
  visited: Boolean,       // 是否已去过
  photos: Array,          // 旅行照片
  diary: String           // 旅行日记
}
```

### 1.6 临时备忘 (MemoNote)

```javascript
{
  ...BasePlan,
  content: String,        // 备忘内容
  category: String,       // 分类
  isUrgent: Boolean,      // 是否紧急
  attachments: Array,     // 附件列表
  location: Object,       // 位置信息 {latitude, longitude, address}
  voice: String,          // 语音备忘URL
  completed: Boolean      // 是否完成
}
```

### 1.7 探店计划 (ShopPlan)

```javascript
{
  ...BasePlan,
  shopName: String,       // 店铺名称
  category: String,       // 店铺类型 (餐厅/咖啡厅/商店等)
  region: String,         // 地区
  address: String,        // 详细地址
  phone: String,          // 联系电话
  openHours: String,      // 营业时间
  avgPrice: Number,       // 人均消费
  rating: Number,         // 评分
  specialties: Array,     // 特色推荐
  visited: Boolean,       // 是否已去过
  visitDate: Date,        // 到访日期
  experience: String,     // 体验感受
  photos: Array,          // 店铺照片
  receipt: String         // 消费凭证
}
```

### 1.8 时间胶囊 (TimeCapsule)

```javascript
{
  _id: String,
  _openid: String,
  coupleId: String,
  title: String,          // 胶囊标题
  content: String,        // 信件内容
  attachments: Array,     // 附件 (照片/音频)
  createTime: Date,       // 创建时间
  sendTime: Date,         // 发送时间
  openTime: Date,         // 开启时间
  status: String,         // 状态: pending/sent/opened
  recipient: String,      // 接收者 (self/partner/both)
  isOpened: Boolean,      // 是否已开启
  openedBy: Array         // 开启记录
}
```

### 1.9 情侣任务 (CoupleTask)

```javascript
{
  ...BasePlan,
  publisher: String,      // 发布者openId
  assignee: String,       // 指派对象openId
  reward: String,         // 悬赏内容
  rewardType: String,     // 悬赏类型 (money/gift/favor)
  rewardValue: Number,    // 悬赏价值
  deadline: Date,         // 截止日期
  acceptTime: Date,       // 接受时间
  completeTime: Date,     // 完成时间
  evidence: Array,        // 完成证据
  feedback: String,       // 反馈评价
  taskStatus: String      // 任务状态: published/accepted/completed/verified/rewarded
}
```

### 1.10 纪念日管理 (Anniversary)

```javascript
{
  _id: String,
  _openid: String,
  coupleId: String,
  name: String,           // 纪念日名称
  type: String,           // 类型: relationship/birthday/festival/custom
  date: Date,             // 日期
  isAnnual: Boolean,      // 是否年度重复
  description: String,    // 描述
  importance: Number,     // 重要程度 1-5
  remindDays: Array,      // 提前提醒天数 [1,3,7,30]
  celebrationPlan: String,// 庆祝计划
  photos: Array,          // 相关照片
  gifts: Array,           // 礼物记录
  createTime: Date
}
```

### 1.11 礼物收集 (GiftCollection)

```javascript
{
  _id: String,
  _openid: String,
  coupleId: String,
  giftName: String,       // 礼物名称
  giver: String,          // 赠送者openId
  receiver: String,       // 接收者openId
  occasion: String,       // 赠送场合
  giftDate: Date,         // 赠送日期
  category: String,       // 礼物类型
  value: Number,          // 价值
  description: String,    // 描述
  photos: Array,          // 礼物照片
  story: String,          // 礼物故事
  isWishlist: Boolean,    // 是否心愿单
  received: Boolean,      // 是否已收到
  rating: Number,         // 喜爱程度
  tags: Array             // 标签
}
```

## 二、页面结构设计

### 2.1 页面路由配置

在 `app.json` 中添加新页面:

```json
{
  "pages": [
    "pages/bind/bind",
    "pages/home/home",
    "pages/space/space",
    "pages/couple-plan/index",
    "pages/couple-plan/movie/movie",
    "pages/couple-plan/cooking/cooking",
    "pages/couple-plan/sport/sport",
    "pages/couple-plan/travel/travel",
    "pages/couple-plan/memo/memo",
    "pages/couple-plan/shop/shop",
    "pages/time-capsule/index",
    "pages/couple-task/index",
    "pages/anniversary/index",
    "pages/gift-collection/index",
    "pages/mini-games/index",
    "pages/index/index",
    "pages/logs/logs"
  ]
}
```

### 2.2 主入口页面 (couple-plan/index)

```
├── 顶部导航栏
│   ├── 计划概览
│   ├── 日历视图
│   └── 设置
├── 快速入口卡片
│   ├── 电影计划 🎬
│   ├── 烹饪计划 🍳
│   ├── 运动打卡 💪
│   ├── 旅游计划 ✈️
│   ├── 临时备忘 📝
│   └── 探店计划 🏪
├── 进行中的计划
│   ├── 计划卡片列表
│   └── 进度展示
└── 底部功能区
    ├── 时间胶囊 ⏰
    ├── 情侣任务 💝
    ├── 纪念日 🎉
    ├── 礼物收集 🎁
    └── 小游戏 🎮
```

## 三、云函数设计

### 3.1 计划管理云函数 (planManager)

```javascript
// cloudfunctions/planManager/index.js
const cloud = require('wx-server-sdk')
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV })
const db = cloud.database()

exports.main = async (event, context) => {
  const { action, data } = event
  const wxContext = cloud.getWXContext()
  
  switch (action) {
    case 'create':
      return await createPlan(data, wxContext.OPENID)
    case 'update':
      return await updatePlan(data, wxContext.OPENID)
    case 'delete':
      return await deletePlan(data, wxContext.OPENID)
    case 'list':
      return await listPlans(data, wxContext.OPENID)
    case 'detail':
      return await getPlanDetail(data, wxContext.OPENID)
    case 'complete':
      return await completePlan(data, wxContext.OPENID)
    default:
      return { success: false, error: 'Invalid action' }
  }
}
```

### 3.2 提醒服务云函数 (reminderService)

```javascript
// cloudfunctions/reminderService/index.js
// 定时触发器，检查需要提醒的计划
exports.main = async (event, context) => {
  const db = cloud.database()
  const now = new Date()
  
  // 查询需要提醒的计划
  const plans = await db.collection('plans')
    .where({
      remindTime: db.command.lte(now),
      status: db.command.neq(2) // 未完成的计划
    })
    .get()
  
  // 发送订阅消息
  for (let plan of plans.data) {
    await sendSubscribeMessage(plan)
  }
}
```

### 3.3 时间胶囊云函数 (timeCapsule)

```javascript
// cloudfunctions/timeCapsule/index.js
// 定时检查并发送时间胶囊
exports.main = async (event, context) => {
  const db = cloud.database()
  const now = new Date()
  
  const capsules = await db.collection('timeCapsules')
    .where({
      sendTime: db.command.lte(now),
      status: 'pending'
    })
    .get()
  
  for (let capsule of capsules.data) {
    await deliverTimeCapsule(capsule)
  }
}
```

## 四、核心功能实现

### 4.1 计划创建流程

1. 用户选择计划类型
2. 填写基础信息 (标题、描述、时间等)
3. 填写特定类型的详细信息
4. 设置提醒和共享权限
5. 保存到云数据库
6. 通知伴侣 (如果是共享计划)

### 4.2 双人协作机制

- **同步状态**: 实时同步计划状态变更
- **权限控制**: 创建者可编辑，伴侣可查看和标记完成
- **冲突解决**: 最后更新时间优先原则
- **离线支持**: 本地缓存 + 云端同步

### 4.3 提醒系统

- **订阅消息**: 利用微信订阅消息API
- **本地提醒**: 结合小程序后台刷新
- **智能提醒**: 根据用户习惯调整提醒时间

### 4.4 数据统计

- **完成率统计**: 按类型、时间维度统计
- **情侣协作度**: 共同完成的计划比例
- **成长轨迹**: 体重变化、技能提升等

## 五、UI/UX设计规范

### 5.1 色彩方案

- **主色调**: #FF69B4 (粉色) - 温馨浪漫
- **辅助色**: #87CEEB (天蓝) - 清新自然
- **强调色**: #FFD700 (金色) - 重要提醒
- **中性色**: #F5F5F5 (浅灰) - 背景色

### 5.2 组件设计

- **计划卡片**: 圆角设计，渐变背景，进度条
- **状态标识**: 图标 + 颜色区分不同状态
- **交互反馈**: 微动画效果，触觉反馈

### 5.3 响应式适配

- 支持不同屏幕尺寸
- 横竖屏自适应
- 无障碍访问支持

## 六、开发计划

### 阶段一：基础框架 (2周)

- [ ] 数据库表结构设计
- [ ] 基础云函数开发
- [ ] 主入口页面开发
- [ ] 用户权限验证

### 阶段二：核心功能 (4周)

- [ ] 电影计划模块
- [ ] 烹饪计划模块
- [ ] 运动打卡模块
- [ ] 旅游计划模块

### 阶段三：扩展功能 (3周)

- [ ] 时间胶囊功能
- [ ] 情侣任务系统
- [ ] 纪念日管理
- [ ] 礼物收集

### 阶段四：优化完善 (2周)

- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 测试和调试
- [ ] 上线部署

## 七、技术要点

### 7.1 性能优化

- **图片懒加载**: 大量图片的页面使用懒加载
- **数据分页**: 列表数据分页加载
- **缓存策略**: 合理使用本地存储和云端缓存
- **代码分包**: 按功能模块分包加载

### 7.2 安全考虑

- **数据校验**: 前后端双重数据校验
- **权限控制**: 基于openId的访问控制
- **敏感信息**: 加密存储敏感数据
- **防刷机制**: 接口调用频率限制

### 7.3 兼容性

- **微信版本**: 支持微信7.0+
- **系统版本**: iOS 10+, Android 5.0+
- **网络环境**: 2G/3G/4G/5G/WiFi

## 八、测试方案

### 8.1 功能测试

- 计划CRUD操作
- 双人协作流程
- 提醒功能
- 数据同步

### 8.2 性能测试

- 页面加载速度
- 大数据量处理
- 网络异常处理
- 内存使用情况

### 8.3 用户体验测试

- 操作流程顺畅性
- 界面响应速度
- 错误提示友好性
- 无障碍访问

## 九、运营策略

### 9.1 用户引导

- 新手引导流程
- 功能介绍动画
- 使用技巧提示

### 9.2 用户留存

- 签到奖励机制
- 成就系统
- 社交分享功能

### 9.3 数据分析

- 用户行为统计
- 功能使用率分析
- 用户反馈收集

---

## 附录

### A. 现有功能集成点

- 复用 `pages/bind/bind.js` 的情侣绑定机制
- 继承 `app.js` 的云开发初始化配置
- 参考 `pages/home/home.js` 的页面结构和状态管理

### B. 第三方服务集成

- 微信订阅消息
- 微信支付 (礼物购买)
- 地图服务 (位置相关功能)
- 天气API (旅游计划)

### C. 数据迁移方案

- 现有用户数据保持不变
- 新功能数据独立存储
- 提供数据导入导出功能

---

*文档版本: v1.0*
*最后更新: 2024年*
*维护者: 开发团队*

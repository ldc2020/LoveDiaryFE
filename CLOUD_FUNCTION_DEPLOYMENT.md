# 云函数部署指南

## 概述

本文档详细说明如何创建和部署 `initDatabase` 云函数，该函数用于自动初始化情侣计划功能所需的数据库集合。

## 前置条件

1. **微信开发者工具**: 确保已安装最新版本的微信开发者工具
2. **云开发环境**: 项目已开通云开发服务
3. **权限配置**: 确保有云函数的创建和部署权限

## 部署步骤

### 1. 在微信开发者工具中部署

#### 方法一：右键部署（推荐）
1. 在微信开发者工具中打开项目
2. 在左侧文件树中找到 `cloudfunctions/initDatabase` 文件夹
3. **右键点击** `initDatabase` 文件夹
4. 选择 **"创建并部署：云端安装依赖（不上传 node_modules）"**
5. 等待部署完成，控制台会显示部署结果

#### 方法二：通过云开发控制台
1. 在微信开发者工具中点击 **"云开发"** 按钮
2. 进入云开发控制台
3. 点击左侧 **"云函数"** 菜单
4. 点击 **"新建云函数"**
5. 输入函数名称：`initDatabase`
6. 选择运行环境：`Node.js 16`
7. 点击 **"确定"** 创建
8. 将本地 `cloudfunctions/initDatabase/` 目录下的所有文件上传到云函数

### 2. 验证部署结果

#### 检查部署状态
1. 在云开发控制台的云函数列表中查看 `initDatabase` 函数
2. 状态应显示为 **"部署成功"** 或 **"正常"**
3. 可以看到函数的基本信息：
   - 函数名称：initDatabase
   - 运行环境：Node.js 16
   - 内存：256MB
   - 超时时间：20秒

#### 测试云函数
1. 在云开发控制台中点击 `initDatabase` 函数
2. 点击 **"测试"** 标签页
3. 点击 **"运行测试"** 按钮
4. 查看执行结果，应该显示成功创建各个数据库集合

### 3. 常见问题及解决方案

#### 问题1：部署失败 - 权限不足
**错误信息**: `权限不足，无法创建云函数`

**解决方案**:
1. 确保微信小程序已开通云开发服务
2. 检查开发者账号是否有管理员权限
3. 在小程序管理后台检查云开发服务状态

#### 问题2：依赖安装失败
**错误信息**: `npm install failed`

**解决方案**:
1. 检查网络连接
2. 尝试使用 **"创建并部署：云端安装依赖"** 选项
3. 如果仍然失败，可以本地安装依赖后选择 **"上传并部署：上传全部文件"**

```bash
# 在 cloudfunctions/initDatabase 目录下执行
npm install
```

#### 问题3：函数执行超时
**错误信息**: `Function execution timeout`

**解决方案**:
1. 在云开发控制台中增加函数超时时间（建议设置为30秒）
2. 优化函数代码，减少执行时间

#### 问题4：数据库权限问题
**错误信息**: `Database permission denied`

**解决方案**:
1. 检查云开发环境的数据库权限设置
2. 确保云函数有数据库的读写权限
3. 在数据库安全规则中添加相应权限

### 4. 手动创建步骤（备用方案）

如果自动部署失败，可以手动创建云函数：

1. **创建云函数目录结构**:
```
cloudfunctions/
└── initDatabase/
    ├── index.js
    └── package.json
```

2. **复制代码文件**:
   - 将 `index.js` 和 `package.json` 文件内容复制到对应位置

3. **在微信开发者工具中**:
   - 右键点击 `cloudfunctions` 文件夹
   - 选择 **"新建 Node.js 云函数"**
   - 输入函数名：`initDatabase`
   - 替换生成的代码文件

### 5. 部署后配置

#### 环境变量配置（如需要）
在云开发控制台的云函数详情页面，可以配置环境变量：
- `DB_ENV`: 数据库环境标识
- `LOG_LEVEL`: 日志级别

#### 触发器配置（可选）
如果需要定时执行，可以配置定时触发器：
1. 在云函数详情页面点击 **"触发器"** 标签
2. 点击 **"创建触发器"**
3. 选择触发器类型：**"定时触发器"**
4. 设置 Cron 表达式（例如：`0 0 * * *` 表示每天0点执行）

## 使用说明

### 在小程序中调用云函数

```javascript
// 在小程序页面中调用
try {
  const result = await wx.cloud.callFunction({
    name: 'initDatabase'
  });
  console.log('数据库初始化成功', result);
} catch (error) {
  console.error('数据库初始化失败', error);
}
```

### 云函数功能说明

`initDatabase` 云函数会自动创建以下数据库集合：

1. **ld_movie_plans** - 电影计划集合
2. **ld_cooking_plans** - 烹饪计划集合
3. **ld_exercise_plans** - 运动计划集合
4. **ld_travel_plans** - 旅游计划集合
5. **ld_memo_plans** - 备忘录集合
6. **ld_shop_plans** - 探店计划集合

每个集合都会插入一条示例数据，然后立即删除，以确保集合被正确创建。

## 监控和日志

### 查看执行日志
1. 在云开发控制台中点击 `initDatabase` 函数
2. 点击 **"日志"** 标签页
3. 查看函数执行的详细日志
4. 可以根据时间范围筛选日志

### 监控指标
在云函数详情页面可以查看：
- 调用次数统计
- 执行时间统计
- 错误率统计
- 资源使用情况

## 安全注意事项

1. **权限控制**: 确保云函数只能被授权用户调用
2. **数据验证**: 在函数中添加必要的数据验证逻辑
3. **错误处理**: 完善错误处理机制，避免敏感信息泄露
4. **日志安全**: 避免在日志中记录敏感信息

## 版本管理

建议为云函数建立版本管理机制：

1. **代码版本**: 使用 Git 管理云函数代码
2. **部署版本**: 在云开发控制台中可以查看部署历史
3. **回滚机制**: 如果新版本有问题，可以快速回滚到上一版本

## 性能优化建议

1. **冷启动优化**: 减少依赖包大小，优化初始化代码
2. **内存使用**: 根据实际需要调整内存配置
3. **并发处理**: 合理设置并发限制
4. **缓存策略**: 对于重复操作，考虑使用缓存

## 故障排除

### 常用调试命令

```bash
# 查看云函数列表
wx-server-sdk list

# 查看特定云函数信息
wx-server-sdk info initDatabase

# 本地测试云函数
wx-server-sdk test initDatabase
```

### 联系支持

如果遇到无法解决的问题：
1. 查看微信开发者文档
2. 在微信开发者社区提问
3. 联系微信技术支持

---

**注意**: 请确保在生产环境部署前充分测试云函数功能，避免对现有数据造成影响。
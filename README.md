# Love Diary - 恋爱日记小程序开发文档

## 项目概述

Love Diary是一款专为情侣设计的微信小程序，提供私密的情侣空间，让恋人们可以记录美好时光、分享生活瞬间。

## 技术架构

### 前端技术

- **框架**: 微信小程序原生框架
- **样式**: WXSS + 自定义组件
- **状态管理**: 本地存储 + 云数据库同步
- **图标库**: 自定义iconfont

### 后端技术

- **云服务**: 微信云开发
- **数据库**: 云数据库 (MongoDB)
- **云函数**: Node.js
- **文件存储**: 云存储

### 核心技术特性

- **智能缓存系统**: 图片本地缓存，支持大小限制和自动清理
- **图片压缩**: 上传时自动压缩，优化存储和传输
- **性能优化**: 防抖处理、懒加载、分页加载
- **实时同步**: 云数据库实时数据同步

## 项目结构

```
Love Diary/
├── app.js                 # 应用入口文件
├── app.json              # 应用配置文件
├── app.wxss              # 全局样式文件
├── cloudfunctions/       # 云函数目录
│   ├── login/           # 用户登录云函数
│   └── unbindCouple/    # 解绑情侣云函数
├── components/          # 自定义组件
│   └── debug-panel/     # 调试面板组件
├── pages/              # 页面目录
│   ├── index/          # 登录注册页面
│   ├── bind/           # 情侣绑定页面
│   ├── home/           # 主页
│   ├── space/          # 情侣空间页面
│   └── logs/           # 日志页面
├── utils/              # 工具函数
└── iconfont/           # 图标字体
```

## 核心功能模块

### 1. 用户系统

- **用户注册登录**: 基于微信授权的用户系统
- **用户信息管理**: 头像、昵称等个人信息设置
- **权限控制**: 基于openid的权限验证

### 2. 情侣绑定系统

- **邀请码生成**: 自动生成唯一邀请码
- **绑定流程**: 双向绑定确认机制
- **绑定状态检查**: 实时检查绑定状态
- **解绑功能**: 支持情侣关系解除

### 3. 相册管理

- **图片上传**: 支持多图上传，自动压缩
- **智能缓存**: 本地图片缓存，提升加载速度
- **背景图片**: 个性化背景图片设置
- **图片浏览**: 支持图片预览和管理

### 4. 瞬间分享

- **发布瞬间**: 图文结合的动态发布
- **评论互动**: 情侣间的私密评论
- **分页加载**: 优化大量数据的加载性能
- **实时同步**: 瞬间数据实时同步

## 数据库设计

### 命名规范

所有数据库集合遵循命名规则：`ld_` + 具体名称 + `_`

### 主要集合

- `ld_user_info`: 用户信息表
- `ld_couple_info`: 情侣关系表
- `ld_moments`: 瞬间动态表
- `ld_comments`: 评论表

## 当前已实现功能

### 主页 (home)

- ✅ 背景图片加载和缓存
- ✅ 轮播图片展示
- ✅ 绑定状态检查
- ✅ 设置弹窗
- ✅ 情侣空间入口

### 情侣空间 (space)

- ✅ 瞬间数据加载和分页
- ✅ 用户和伴侣信息展示
- ✅ 智能图片缓存系统
- ✅ 发布瞬间功能
- ✅ 评论互动功能

### 绑定页面 (bind)

- ✅ 邀请码生成和展示
- ✅ 伴侣邀请码输入
- ✅ 绑定状态实时检查
- ✅ 自动绑定完成

### 登录注册 (index)

- ✅ 微信授权登录
- ✅ 用户信息收集
- ✅ 重复注册检查
- ✅ 用户信息更新

## 待开发功能 (与情侣空间同等级入口)

### 1. 情侣计划 (Couple Plans)

**入口位置**: 主页 - 与情侣空间同级

要求：

1.这里面的所有内容绑定好的两个情侣都能修改，都可见

2.情侣计划页面提供一个信息框供用户输入，然后能够智能识别用户粘贴进来的信息自动归类到电影计划还是别的什么可以归类的计划，智能提取上面的内容，然后添加到小项中（如果有的话）

开发要用到云存储

#### 1.1 电影计划

- **电影名字**: 计划观看的电影标题
- **电影信息**: 导演、演员、类型、时长等详细信息
- **是否看过**: 标记观看状态

#### 1.2 烹饪计划

- **食材**: 所需食材清单
- **用量**: 每种食材的具体用量
- **是否尝试打分**: 完成后的评分系统

#### 1.3 运动打卡

- **体重目标**: 设定目标体重
- **体重曲线**: 体重变化趋势图表

#### 1.4 旅游计划

- **行程**: 详细的旅游行程安排
- **日期**: 计划出行日期
- **是否去过**: 标记完成状态

#### 1.5 临时备忘

- **未来某人的记录**: 临时想法和备忘录

#### 1.6 探店计划

- **地区**: 目标探店区域
- **店铺名字**: 想要探访的店铺
- **是否去过**: 探店完成状态

### 2. 时间胶囊 (Time Capsule)

**入口位置**: 主页 - 与情侣空间同级

- **未来的信件**: 写给未来自己或对方的信件
- **定时发送**: 设定特定时间自动发送

### 3. 情侣任务 (Couple Tasks)

**入口位置**: 主页 - 与情侣空间同级

- **发布和接收**: 任务发布和接收机制
- **悬赏**: 任务奖励系统
- **截止日期**: 任务完成期限

### 4. 纪念日管理 (Anniversary)

**入口位置**: 主页 - 与情侣空间同级

#### 4.1 纪念日

- **重要纪念日**: 恋爱纪念日、生日等重要日期
- **第一次纪念日**: 第一次约会、第一次牵手等特殊时刻
- **生日**: 双方生日管理
- **情人节**: 各种情人节提醒

#### 4.2 倒数日

- **倒数计时**: 距离重要日期的倒数显示
- **提醒功能**: 临近日期的提醒通知

### 5. 礼物收集 (Gift Collection)

**入口位置**: 主页 - 与情侣空间同级

- **照片**: 礼物照片记录
- **描述**: 礼物详细描述和意义

## 开发规范

### 代码注释

- 使用JSDoc3风格的注释
- 注释应说明"为什么"和"如何"，而不仅仅是"什么"
- 每个函数都应有清晰的注释说明

### 日志记录

- 使用Winston进行日志记录
- 记录每个逻辑连接和工作流程
- 根据不同的工作流程和逻辑使用不同的日志级别

### 错误处理

- 统一的错误处理机制
- 用户友好的错误提示
- 详细的错误日志记录

### 图片处理

- 所有上传功能都必须包含图片压缩
- 智能缓存管理，避免内存溢出
- 支持多种图片格式

## 调试工具

### Debug Panel组件

- **缓存统计**: 显示当前缓存使用情况
- **文件统计**: 本地文件存储统计
- **权限控制**: 基于openid的调试权限
- **详细信息**: 缓存和文件的详细列表

## 部署配置

### 项目配置

- **编译类型**: miniprogram
- **库版本**: 3.5.7
- **插件**: TypeScript支持
- **云函数根目录**: cloudfunctions

### 性能优化

- **懒加载**: 代码包懒加载
- **分包**: 支持分包加载
- **缓存策略**: 智能缓存管理
- **图片优化**: 自动压缩和格式优化

## 后续开发建议

### 功能扩展

1. **推送通知**: 重要事件的消息推送
2. **数据导出**: 支持数据备份和导出
3. **主题定制**: 更多个性化主题选择
4. **语音消息**: 支持语音记录和播放
5. **视频分享**: 短视频分享功能

### 技术优化

1. **离线支持**: 离线数据缓存和同步
2. **性能监控**: 更完善的性能监控体系
3. **安全加固**: 数据加密和安全传输
4. **国际化**: 多语言支持

## 重要注意事项

### 安全考虑

- 用户数据隐私保护
- 情侣数据访问权限控制
- 敏感信息加密存储

### 性能考虑

- 图片缓存大小限制
- 数据分页加载
- 防抖和节流处理

### 用户体验

- 加载状态提示
- 错误友好提示
- 操作反馈及时

## 版本历史

### 当前版本特性

- ✅ 缓存清理修复：`removeCacheItem`函数现在会同时删除本地存储中的相关数据
- ✅ 强制图片上传：发布瞬间时必须至少选择一张图片
- ✅ 代码重构：提取 `executePublish`方法，提高代码可维护性
- ✅ 性能优化：网络请求、图片处理、代码执行等多方面优化
- ✅ 调试工具：完善的调试面板，支持缓存和文件统计

---

*最后更新时间: 2024年*
*开发团队: Love Diary Team*

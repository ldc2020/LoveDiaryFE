# 烹饪计划功能调用流程文档

## 概述

烹饪计划功能是Love Diary小程序中的智能菜谱生成和管理模块，支持AI智能菜谱生成、菜谱管理、图片上传和详情展示等功能。本文档详细描述了各个场景下的方法调用时机和数据流转过程。

## 技术架构

### 核心组件
- **页面文件**: `pages/plan/cooking/cooking.js`
- **数据管理**: `utils/dataManager.js`
- **数据库集合**: `ld_cooking_plans`
- **云存储**: 用于存储成品图片

### 数据管理配置
```javascript
const COLLECTION_NAME = 'ld_cooking_plans';
const CACHE_PREFIX = 'cooking_plans';
const PAGE_SIZE = 20;
const CLEANUP_INTERVAL = 2 * 24 * 60 * 60 * 1000; // 2天清理一次
const RETENTION_PERIOD = 30 * 24 * 60 * 60 * 1000; // 保留30天数据
```

## 场景一：页面初始化

### 调用流程

1. **页面加载** (`onLoad`)
   - 检查用户绑定状态
   - 初始化用户信息 (`initUserInfo`)
   - 初始化数据管理器 (`initDataManager`)
   - 加载菜谱数据 (`loadRecipeData`)

2. **数据管理器初始化** (`initDataManager`)
   ```javascript
   this.dataManager = new DataManager({
     collectionName: COLLECTION_NAME,
     cachePrefix: CACHE_PREFIX,
     pageSize: PAGE_SIZE,
     cleanupInterval: CLEANUP_INTERVAL,
     retentionPeriod: RETENTION_PERIOD,
     hasImages: true, // 支持图片缓存
     timestampField: 'createTime',
     sortField: 'createTime',
     sortOrder: 'desc'
   });
   ```

3. **首次数据加载** (`loadRecipeData`)
   - 调用 `dataManager.getData(false, false)`
   - 智能缓存检查和数据合并
   - 更新页面数据状态

### 调用时机
- 用户首次进入烹饪计划页面
- 页面从后台切换到前台

## 场景二：智能菜谱生成

### 调用流程

1. **显示添加弹窗** (`showAddRecipeModal`)
   - 重置输入状态
   - 显示智能输入界面

2. **用户输入处理** (`onInputChange`)
   - 实时更新输入文本
   - 字符计数显示

3. **智能生成菜谱** (`generateRecipe`)
   - 输入验证
   - 判断输入类型 (`isSimpleDishName`)
   - 根据类型调用不同生成方法：
     - 简单菜名：`generateFullRecipe`
     - 完整菜谱：`formatExistingRecipe`
   - 保存到数据库 (`saveRecipe`)
   - 刷新列表数据

### 菜谱生成逻辑

#### 简单菜名生成 (`generateFullRecipe`)
```javascript
// 1. 检查预设模板
const recipeTemplates = this.getRecipeTemplates();
const template = recipeTemplates[dishName] || this.generateDefaultRecipe(dishName);

// 2. 构建菜谱数据
return {
  dishName: dishName,
  description: template.description,
  ingredients: template.ingredients,
  steps: template.steps,
  cookingTime: template.cookingTime,
  servings: 2, // 默认2人份
  difficulty: template.difficulty || '简单',
  tags: template.tags || ['家常菜'],
  emoji: template.emoji || '🍽️'
};
```

#### 现有菜谱整理 (`formatExistingRecipe`)
```javascript
// 1. 解析文本结构
const lines = recipeText.split('\n').filter(line => line.trim());
const dishName = lines[0].trim();

// 2. 提取各部分信息
const ingredients = this.parseIngredients(recipeText);
const steps = this.parseSteps(recipeText);
const cookingTime = this.parseCookingTime(recipeText);

// 3. 智能添加emoji
const emoji = this.getDishEmoji(dishName);
```

### 调用时机
- 用户点击"智能添加菜谱"按钮
- 用户输入内容后点击"智能生成"

## 场景三：菜谱列表管理

### 下拉刷新 (`onPullDownRefresh`)
```javascript
// 调用流程
1. 触发下拉刷新手势
2. 调用 loadRecipeData(true, false)
3. dataManager.getData(true, false) - 刷新模式
4. 检查云端新数据
5. 更新本地缓存
6. 停止刷新动画
```

### 上拉加载更多 (`onReachBottom`)
```javascript
// 调用流程
1. 滚动到页面底部
2. 检查是否还有更多数据
3. 调用 loadRecipeData(false, true)
4. dataManager.getData(false, true) - 懒加载模式
5. 追加新数据到列表
```

### 调用时机
- 用户下拉刷新页面
- 用户滚动到页面底部
- 添加新菜谱后自动刷新

## 场景四：菜谱详情查看

### 调用流程

1. **点击菜谱卡片** (`onRecipeCardTap`)
   - 获取菜谱数据
   - 显示详情弹窗
   - 初始化编辑状态

2. **详情展示**
   - 显示菜谱基本信息
   - 展示食材列表（带emoji）
   - 显示制作步骤
   - 展示成品图片（如有）

### 调用时机
- 用户点击任意菜谱卡片
- 从编辑模式返回查看模式

## 场景五：菜谱编辑

### 调用流程

1. **开始编辑** (`startEditRecipe`)
   - 深拷贝当前菜谱数据
   - 切换到编辑模式
   - 显示编辑表单

2. **编辑输入处理** (`onEditInputChange`)
   - 实时更新编辑数据
   - 支持多字段编辑

3. **保存编辑** (`saveEdit`)
   - 数据验证
   - 更新数据库记录
   - 更新本地缓存
   - 刷新界面显示

4. **取消编辑** (`cancelEdit`)
   - 恢复原始数据
   - 退出编辑模式

### 调用时机
- 用户在详情页点击"编辑"按钮
- 编辑过程中的实时输入
- 用户点击"保存"或"取消"

## 场景六：菜谱删除

### 调用流程

1. **删除确认** (`deleteRecipe`)
   - 显示确认对话框
   - 用户确认删除意图

2. **执行删除**
   - 从数据库删除记录
   - 更新本地列表数据
   - 关闭详情弹窗
   - 显示删除成功提示

### 调用时机
- 用户在详情页点击"删除"按钮
- 用户确认删除操作

## 场景七：成品图片上传

### 调用流程

1. **选择图片** (`uploadFinishedImage`)
   - 调用微信选择图片API
   - 自动压缩图片
   - 设置上传状态

2. **上传到云存储**
   ```javascript
   const uploadResult = await wx.cloud.uploadFile({
     cloudPath: `cooking/${this.data.coupleId}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`,
     filePath: tempFilePath
   });
   ```

3. **更新数据库**
   - 保存图片URL到菜谱记录
   - 更新本地缓存数据
   - 刷新界面显示

### 调用时机
- 用户在详情页点击"上传成品图"按钮
- 图片选择和上传完成后

## 场景八：数据缓存管理

### 智能缓存策略

1. **缓存初始化**
   - 页面加载时自动初始化
   - 检查缓存统计信息
   - 判断是否需要清理

2. **数据获取优先级**
   ```javascript
   // 1. 检查本地缓存
   // 2. 对比云端数据时间戳
   // 3. 智能合并新旧数据
   // 4. 更新本地缓存
   ```

3. **自动清理机制**
   - 每2天检查一次
   - 清理30天前的数据
   - 保持缓存大小合理

### 调用时机
- 页面初始化时
- 数据刷新时
- 定时清理触发时

## 数据结构定义

### 菜谱数据结构
```javascript
{
  _id: String,              // 数据库ID
  dishName: String,         // 菜品名称
  description: String,      // 菜谱描述
  ingredients: [            // 食材列表
    {
      name: String,         // 食材名称
      amount: String,       // 用量
      emoji: String         // 食材emoji
    }
  ],
  steps: [String],          // 制作步骤
  cookingTime: Number,      // 烹饪时间（分钟）
  servings: Number,         // 份量（人数）
  difficulty: String,       // 难度等级
  tags: [String],           // 标签
  emoji: String,            // 菜品emoji
  finishedImage: String,    // 成品图片URL
  coupleId: String,         // 情侣ID
  creatorId: String,        // 创建者ID
  creatorName: String,      // 创建者昵称
  createTime: Date,         // 创建时间
  updateTime: Date,         // 更新时间
  status: String,           // 状态
  likes: Number,            // 点赞数
  comments: [Object]        // 评论列表
}
```

## 错误处理机制

### 网络错误处理
- 自动重试机制
- 降级到本地缓存
- 用户友好的错误提示

### 数据验证
- 输入内容验证
- 图片格式和大小检查
- 数据完整性校验

### 异常恢复
- 页面状态重置
- 缓存数据恢复
- 用户操作回滚

## 性能优化策略

### 图片处理
- 自动压缩上传图片
- 懒加载图片显示
- 本地图片缓存

### 数据加载
- 分页懒加载（每页20条）
- 智能缓存策略
- 增量数据更新

### 用户体验
- 加载状态提示
- 操作反馈动画
- 离线数据支持

## 总结

烹饪计划功能通过智能的数据管理和用户交互设计，提供了完整的菜谱生成、管理和分享体验。关键特性包括：

1. **智能菜谱生成**：支持简单菜名和完整菜谱两种输入模式
2. **高效数据管理**：使用DataManager实现智能缓存和懒加载
3. **丰富的交互体验**：支持编辑、删除、图片上传等完整操作
4. **性能优化**：图片压缩、分页加载、缓存策略等
5. **错误处理**：完善的异常处理和用户提示机制

该功能模块可以作为其他计划类型页面的参考实现，具有良好的可扩展性和维护性。